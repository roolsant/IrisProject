<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ca√ßa-Cores</title>
    
	<link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0288D1">
    <link rel="apple-touch-icon" href="img/icon-192.png">

    <style>
        /* --- BLOCO 1: ESTILO GERAL (BASE) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Fredoka', sans-serif;
            background-color: #E0F7FA;
            color: #333; 
            text-align: center; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            height: 100dvh; 
            margin: 0; overflow: hidden;
            padding-top: 10px;
        }

        /* --- TELA INICIAL --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4FC3F7, #81C784, #FFF176, #FF8A65, #BA68C8);
            background-size: 400% 400%;
            animation: rainbowBG 18s ease infinite;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 2000;
            padding: 15px;
            overflow: hidden;
        }

        @keyframes rainbowBG { 
            0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%}
        }

        /* --- STICKERS (Configura√ß√£o Padr√£o PC) --- */
        .bg-sticker {
            position: absolute; z-index: 0; 
            filter: drop-shadow(3px 5px 2px rgba(0,0,0,0.15));
            pointer-events: none; opacity: 0.95;
            transition: all 0.3s ease; /* Suaviza a mudan√ßa quando gira a tela */
        }

        /* Posi√ß√µes PC */
        #s-aquarela { top: 2%; left: 2%; width: 70px; transform: rotate(-15deg); }
        #s-arcoiris { top: 2%; right: 2%; width: 90px; transform: rotate(5deg); }
        #s-sol { top: 15%; right: 5%; width: 70px; transform: rotate(10deg); }
        #s-morango { top: 20%; left: 2%; width: 55px; transform: rotate(20deg); }
        #s-estrela { top: 38%; left: 5%; width: 50px; transform: rotate(-15deg); }
        #s-sorvete { top: 55%; left: 2%; width: 50px; transform: rotate(15deg); }
        #s-gatinho { bottom: 25%; left: 5%; width: 60px; transform: rotate(-10deg); }
        #s-flor { top: 30%; right: 8%; width: 55px; transform: rotate(-10deg); }
        #s-giz { top: 45%; right: 2%; width: 45px; transform: rotate(30deg); }
        #s-frutas { top: 60%; right: 5%; width: 60px; transform: rotate(-5deg); }
        #s-cachorrinho { bottom: 25%; right: 5%; width: 60px; transform: rotate(10deg); }
        #s-sapo { bottom: 2%; left: 2%; width: 60px; transform: rotate(15deg); }
        #s-polvo { bottom: 12%; left: 15%; width: 55px; transform: rotate(-5deg); }
        #s-bombeiro { bottom: 12%; left: 5%; width: 75px; transform: rotate(10deg); }
        #s-tigre { bottom: 12%; right: 18%; width: 55px; transform: rotate(5deg); }
        #s-porquinho { bottom: 2%; right: 2%; width: 60px; transform: rotate(-15deg); }

        /* --- T√çTULO --- */
        #game-title-img {
            width: 90%; max-width: 360px; height: auto; margin-bottom: 5px;
            filter: drop-shadow(0px 5px 0px rgba(0,0,0,0.15));
            animation: floatTitle 3s ease-in-out infinite;
            position: relative; z-index: 10;
        }
        @keyframes floatTitle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- VISUAL CENTRAL --- */
        .visual-container {
            position: relative; width: 300px; height: 300px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 10px auto; z-index: 10;
        }
        #camera-lens-img {
            width: 240px; height: 240px; object-fit: contain;
            position: relative; z-index: 1;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.25));
        }
        #mascot-intro-img {
            position: absolute; right: -15px; bottom: -5px; width: 160px;
            z-index: 2; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
            animation: floatMascot 4s ease-in-out infinite;
        }
        @keyframes floatMascot { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(2deg); } }

        /* --- INPUTS --- */
        #player-name {
            padding: 12px; font-size: 18px; border-radius: 50px; border: 4px solid #fff;
            width: 85%; max-width: 280px; margin-bottom: 15px; text-align: center;
            font-family: 'Fredoka', sans-serif; outline: none;
            background: rgba(255,255,255,0.95); color: #0277BD; font-weight: bold;
            box-shadow: 0 4px 5px rgba(0,0,0,0.1); z-index: 10;
        }
        
        #start-btn {
            background: #0288D1; color: #fff; border: 4px solid #fff; 
            padding: 12px 35px; font-size: 22px; border-radius: 50px; font-weight: 800; 
            cursor: pointer; box-shadow: 0 6px 0px #01579B, 0 10px 15px rgba(0,0,0,0.2);
            font-family: 'Fredoka', sans-serif; transition: transform 0.1s;
            display: flex; align-items: center; gap: 10px; z-index: 10;
        }
        #start-btn:active { transform: translateY(6px); box-shadow: 0 0px 0px #01579B; }
        
        .cam-icon {
            width: 24px; height: 18px; background: white; border-radius: 3px; position: relative;
        }
        .cam-icon::before { content:''; position: absolute; top:-4px; left:50%; translate:-50%; width: 8px; height: 4px; background: white; border-radius: 2px 2px 0 0;}
        .cam-icon::after { content:''; position: absolute; top:50%; left:50%; translate:-50% -50%; width: 10px; height: 10px; border: 2px solid #0288D1; border-radius: 50%;}

        #subtitle-text {
            color: #01579B; margin-top: 25px; font-size: 16px; font-weight: 800; 
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5); max-width: 90%;
            line-height: 1.3; text-transform: uppercase; z-index: 10;
        }

        /* =========================================
           AJUSTES PARA CELULAR (MODO RETRATO)
           ========================================= */
        @media (max-width: 600px) {
            /* Diminuir um pouco o container central para caber em telas pequenas */
            .visual-container { width: 260px; height: 260px; margin-bottom: 5px; }
            #camera-lens-img { width: 200px; height: 200px; }
            #mascot-intro-img { width: 130px; right: -5px; bottom: 0px; }
            #game-title-img { max-width: 300px; margin-top: 10px; }

            /* Reorganizar Stickers para n√£o cobrir o texto no celular */
            /* Diminuir o tamanho geral dos stickers no celular */
            .bg-sticker { width: 45px !important; } 
            
            /* Empurrar para os cantos extremos */
            #s-aquarela { top: 1%; left: 1%; }
            #s-arcoiris { top: 1%; right: 1%; width: 70px !important; }
            
            #s-morango { top: 15%; left: -5px; } /* Mais pra borda */
            #s-flor { top: 15%; right: -5px; }   /* Mais pra borda */
            
            #s-sol { top: 28%; right: -10px; }   /* Longe do t√≠tulo */
            #s-estrela { top: 28%; left: -10px; } /* Longe do t√≠tulo */

            #s-sorvete { top: 45%; left: -5px; }
            #s-giz { top: 45%; right: -5px; }

            /* √Årea inferior (evitar sobrepor o subt√≠tulo) */
            #s-bombeiro { bottom: 2%; left: 2%; width: 60px !important; }
            #s-tigre { bottom: 2%; right: 2%; }
            
            /* Esconder alguns stickers no celular para n√£o poluir demais */
            #s-gatinho, #s-cachorrinho, #s-frutas, #s-polvo { display: none; }
        }

        /* --- JOGO PRINCIPAL --- */
        #exit-btn {
            position: absolute; top: 15px; right: 15px;
            background-color: #FF5252; color: white; border: none;
            width: 45px; height: 45px; border-radius: 50%;
            font-weight: bold; font-size: 20px;
            cursor: pointer; z-index: 1000; display: none;
            box-shadow: 0 4px 0px #D32F2F;
            align-items: center; justify-content: center;
        }
        #exit-btn:active { transform: translateY(4px); box-shadow: none; }

        #scanner-frame {
            position: relative; width: 90vw; max-width: 380px; aspect-ratio: 1 / 1; margin-top: 15px;
            border-radius: 30px; overflow: hidden; border: 8px solid #FFF;
            box-shadow: 0 10px 25px rgba(0,188,212, 0.4); background: #000;
            display: none; z-index: 5; transition: border-color 0.3s ease;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #scanner-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px; z-index: 6; pointer-events: none;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 80px; height: 80px;
            transform: translate(-50%, -50%); border: 4px dashed rgba(255,255,255,0.8);
            border-radius: 20px; z-index: 7; animation: breathe 2s infinite;
        }
        @keyframes breathe { 0%, 100% { scale: 1; opacity: 0.8; } 50% { scale: 1.1; opacity: 1; } }

        #curiosity-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        #curiosity-card.active { opacity: 1; pointer-events: auto; }
        #victory-title { font-size: 28px; color: #4CAF50; margin-bottom: 10px; font-weight: 800; text-transform: uppercase; text-shadow: 1px 1px 0px rgba(0,0,0,0.1); }
        #curiosity-img-wrapper {
            width: 90%; height: 60%; border-radius: 20px; overflow: hidden; background: #fff;
            border: 3px solid #eee; position: relative; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #curiosity-image { width: 100%; height: 100%; object-fit: cover; display: block; }
        #backup-emoji { font-size: 100px; display: none; animation: bounce 1s infinite alternate; }

        #target-bar {
            margin-top: -25px; z-index: 20; background: #fff; padding: 10px 30px;
            border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: inline-flex; align-items: center; gap: 10px;
            transform: scale(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #target-text { font-size: 26px; font-weight: 800; text-transform: uppercase; color: #333;}
        #target-dot { width: 28px; height: 28px; border-radius: 50%; border: 3px solid #eee; background: #ccc; }

        #bottom-area {
            position: fixed; bottom: 0; left: 0; width: 100%; display: none; 
            flex-direction: column; justify-content: flex-end; padding-bottom: 20px;
            pointer-events: none; z-index: 200; 
        }
        #character-row {
            display: flex; align-items: flex-end; justify-content: center;
            width: 100%; padding: 0 10px; margin-bottom: 10px;
        }
        
        #in-game-mascot {
            width: 120px; height: auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            margin-right: -10px; z-index: 205; animation: breatheMascot 3s ease-in-out infinite;
        }
        @keyframes breatheMascot { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }

        #speech-bubble {
            background: #fff; border: 4px solid #00E5FF; border-radius: 25px 25px 25px 5px;
            padding: 15px 20px; margin-left: 5px; margin-bottom: 40px; 
            font-size: 18px; line-height: 1.3; font-weight: 700; color: #333;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.15); opacity: 0; transition: opacity 0.3s;
            max-width: 65%; white-space: pre-line; text-align: left; pointer-events: auto; z-index: 201;
        }
        #skip-btn {
            background-color: #FF8A65; color: white; border: none; padding: 15px 50px; 
            font-size: 20px; border-radius: 50px; font-weight: 700; 
            box-shadow: 0 6px 0px #E64A19; cursor: pointer; pointer-events: auto;
            margin: 0 auto; display: none; align-items: center; gap: 10px;
            font-family: 'Fredoka', sans-serif; transition: transform 0.1s;
        }
        #skip-btn:active { transform: translateY(6px); box-shadow: none; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        
        <img id="s-aquarela" class="bg-sticker" src="img/stickers/sticker_aquarela.png" alt="Aquarela">
        <img id="s-sol" class="bg-sticker" src="img/stickers/sticker_sol.png" alt="Sol">
        <img id="s-arcoiris" class="bg-sticker" src="img/stickers/sticker_arcoiris.png" alt="Arco-√≠ris">
        <img id="s-morango" class="bg-sticker" src="img/stickers/sticker_morango.png" alt="Morango">
        <img id="s-flor" class="bg-sticker" src="img/stickers/sticker_flor.png" alt="Flor">
        <img id="s-estrela" class="bg-sticker" src="img/stickers/sticker_estrela.png" alt="Estrela">
        <img id="s-giz" class="bg-sticker" src="img/stickers/sticker_giz.png" alt="Giz">
        <img id="s-sorvete" class="bg-sticker" src="img/stickers/sticker_sorvete.png" alt="Sorvete">
        <img id="s-frutas" class="bg-sticker" src="img/stickers/sticker_frutas.png" alt="Frutas">
        <img id="s-gatinho" class="bg-sticker" src="img/stickers/sticker_gatinho.png" alt="Gatinho">
        <img id="s-cachorrinho" class="bg-sticker" src="img/stickers/sticker_cachorrinho.png" alt="Cachorrinho">
        <img id="s-polvo" class="bg-sticker" src="img/stickers/sticker_polvo.png" alt="Polvo">
        <img id="s-tigre" class="bg-sticker" src="img/stickers/sticker_tigre.png" alt="Tigre">
        <img id="s-sapo" class="bg-sticker" src="img/stickers/sticker_sapo.png" alt="Sapo">
        <img id="s-porquinho" class="bg-sticker" src="img/stickers/sticker_porquinho.png" alt="Porquinho">
        <img id="s-bombeiro" class="bg-sticker" src="img/stickers/sticker_caminhao_bombeiro.png" alt="Bombeiro">

        <img id="game-title-img" src="img/titulo_game.png" alt="CA√áA-CORES!">
        
        <div class="visual-container">
            <img id="camera-lens-img" src="img/lente_camera.png" alt="Lente da C√¢mera">
            <img id="mascot-intro-img" src="img/mascote_intro.png" alt="Camale√£o">
        </div>

        <input type="text" id="player-name" placeholder="Digite seu nome" autocomplete="off">
        
        <button id="start-btn" onclick="startGame()">
            <div class="cam-icon"></div> JOGAR AGORA!
        </button>
        
        <div id="subtitle-text">ENCONTRE E MOSTRE UMA COR!<br>A GENTE TE CONTA UMA CURIOSIDADE.</div>
    </div>

    <button id="exit-btn" onclick="endGame()">X</button>

    <div id="scanner-frame">
        <div id="scanner-overlay"></div> 
        <div id="crosshair"></div>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>

        <div id="curiosity-card">
            <div id="victory-title">MUITO BEM! üéâ</div>
            <div id="curiosity-img-wrapper">
                <img id="curiosity-image" src="" alt="Foto">
                <div id="backup-emoji"></div>
            </div>
        </div>
    </div>

    <div id="target-bar">
        <div id="target-text">...</div>
        <div id="target-dot"></div>
    </div>

    <div id="bottom-area">
        <div id="character-row">
            <img id="in-game-mascot" src="img/mascote_intro.png" alt="√çris">
            <div id="speech-bubble">Ol√°! Digite seu nome para come√ßar.</div>
        </div>

        <button id="skip-btn" onclick="skipChallenge()">PULAR ‚è©</button>
    </div>

    <script>
        /* --- L√ìGICA V63 (MANTIDA) --- */
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const targetText = document.getElementById('target-text');
        const targetDot = document.getElementById('target-dot');
        const targetBar = document.getElementById('target-bar');
        const curiosityCard = document.getElementById('curiosity-card');
        const curiosityImage = document.getElementById('curiosity-image');
        const backupEmoji = document.getElementById('backup-emoji');
        const victoryTitle = document.getElementById('victory-title');
        const skipBtn = document.getElementById('skip-btn');
        const exitBtn = document.getElementById('exit-btn');
        const scannerFrame = document.getElementById('scanner-frame');
        const bottomArea = document.getElementById('bottom-area');
        const startScreen = document.getElementById('start-screen');
        const bubbleText = document.getElementById('speech-bubble');
        const nameInput = document.getElementById('player-name');

        let childName = "";
        let currentTarget = null; 
        let currentFactIndex = -1;
        let gameStarted = false; 
        let lockGame = false;
        let holdCounter = 0;
        let voice = null; 
        let lastWrongColorName = ""; 
        let wrongColorCounter = 0;
        let errorCooldown = false;
        let idleTimer15 = null; 
        let idleTimer60 = null; 
        let challengeBag = [];

        const targets = {
            "Vermelho": { 
                hueMin: 340, hueMax: 20, satMin: 40, ligMin: 20, ligMax: 80, color: "#FF1744", 
                facts: [
                    {text: "o morango √© a √∫nica fruta com as sementes do lado de fora! S√£o umas 200 sementinhas.", img: "img/vermelho/morango_vermelho.jpg", emoji: "üçì"},
                    {text: "existem morangos brancos e amarelos, n√£o s√≥ vermelhos!", img: "img/vermelho/morango_vermelho.jpg", emoji: "üçì"},
                    {text: "o morango √© da fam√≠lia das rosas. As flores deles s√£o parecidas!", img: "img/vermelho/morango_vermelho.jpg", emoji: "üçì"},
                    {text: "a escada desse caminh√£o pode esticar at√© 60 metros de altura para salvamentos.", img: "img/vermelho/bombeiro_vermelho.jpg", emoji: "üöí"},
                    {text: "o vermelho serve para todo mundo ver o caminh√£o bem r√°pido na rua!", img: "img/vermelho/bombeiro_vermelho.jpg", emoji: "üöí"},
                    {text: "um caminh√£o de bombeiro pode carregar 5 mil litros de √°gua.", img: "img/vermelho/bombeiro_vermelho.jpg", emoji: "üöí"},
                    {text: "a joaninha come pulg√µes e ajuda a proteger as plantinhas do jardim.", img: "img/vermelho/joaninha_vermelha.jpg", emoji: "üêû"},
                    {text: "a cor vermelha e preta avisa os passarinhos que ela n√£o tem um gosto bom.", img: "img/vermelho/joaninha_vermelha.jpg", emoji: "üêû"},
                    {text: "quando a joaninha dorme no inverno, ela se junta com outras para se esquentar.", img: "img/vermelho/joaninha_vermelha.jpg", emoji: "üêû"},
                    {text: "a casca da ma√ß√£ tem muitas vitaminas. √â bom lavar bem e comer!", img: "img/vermelho/maca_vermelha.jpg", emoji: "üçé"},
                    {text: "existem milhares de tipos de ma√ß√£ no mundo. A Fuji √© uma das mais doces!", img: "img/vermelho/maca_vermelha.jpg", emoji: "üçé"},
                    {text: "ma√ß√£s ajudam a limpar os dentes enquanto voc√™ mastiga, pois s√£o crocantes.", img: "img/vermelho/maca_vermelha.jpg", emoji: "üçé"},
                    {text: "rosas vermelhas s√£o usadas h√° milhares de anos para dizer 'voc√™ √© especial'.", img: "img/vermelho/rosa_vermelha.jpg", emoji: "üåπ"},
                    {text: "o Equador √© o pa√≠s que mais produz rosas no mundo.", img: "img/vermelho/rosa_vermelha.jpg", emoji: "üåπ"}
                ] 
            },
            "Laranja": { 
                hueMin: 21, hueMax: 35, satMin: 40, ligMin: 30, ligMax: 85, color: "#FF6D00", 
                facts: [
                    {text: "antigamente as cenouras eram roxas ou brancas, n√£o laranjas!", img: "img/laranja/cenoura_laranja.jpg", emoji: "ü•ï"},
                    {text: "comer cenoura ajuda seus olhos a enxergarem melhor e protege a pele.", img: "img/laranja/cenoura_laranja.jpg", emoji: "ü•ï"},
                    {text: "a cenoura √© parente da salsinha que a gente usa na salada.", img: "img/laranja/cenoura_laranja.jpg", emoji: "ü•ï"},
                    {text: "as listras do tigre funcionam como camuflagem para ele se esconder no mato.", img: "img/laranja/tigre_laranja.jpg", emoji: "üêÖ"},
                    {text: "tigres adoram √°gua e s√£o √≥timos nadadores, diferente dos gatinhos.", img: "img/laranja/tigre_laranja.jpg", emoji: "üêÖ"},
                    {text: "o tigre consegue dar um pulo de 5 metros de altura!", img: "img/laranja/tigre_laranja.jpg", emoji: "üêÖ"},
                    {text: "o nome da cor 'laranja' veio da fruta, sabia disso?", img: "img/laranja/fruta_laranja.jpg", emoji: "üçä"},
                    {text: "o Brasil √© o maior produtor de suco de laranja do mundo todo.", img: "img/laranja/fruta_laranja.jpg", emoji: "üçä"},
                    {text: "a bola de basquete √© laranja para os jogadores verem ela melhor na quadra.", img: "img/laranja/basquete_laranja.jpg", emoji: "üèÄ"},
                    {text: "as linhas pretas na bola ajudam a m√£o a n√£o escorregar e mant√™m o formato.", img: "img/laranja/basquete_laranja.jpg", emoji: "üèÄ"},
                    {text: "o peixe-palha√ßo tem uma gosminha no corpo que protege ele de queimaduras.", img: "img/laranja/peixe_laranja.jpg", emoji: "üê†"},
                    {text: "o papai peixe-palha√ßo √© quem cuida dos ovinhos at√© eles nascerem.", img: "img/laranja/peixe_laranja.jpg", emoji: "üê†"}
                ] 
            },
            "Amarelo": { 
                hueMin: 36, hueMax: 70, satMin: 30, ligMin: 20, ligMax: 95, color: "#FFD600", 
                facts: [
                    {text: "a luz do Sol leva 8 minutos para viajar do espa√ßo at√© chegar aqui.", img: "img/amarelo/sol_amarelo.jpg", emoji: "‚òÄÔ∏è"},
                    {text: "o Sol √© t√£o grande que caberiam um milh√£o de Terras dentro dele.", img: "img/amarelo/sol_amarelo.jpg", emoji: "‚òÄÔ∏è"},
                    {text: "o girassol jovem gira o pesco√ßo para acompanhar o sol no c√©u.", img: "img/amarelo/girassol_amarelo.jpg", emoji: "üåª"},
                    {text: "as sementes do girassol formam um desenho matem√°tico perfeito.", img: "img/amarelo/girassol_amarelo.jpg", emoji: "üåª"},
                    {text: "a banana d√° muita energia para brincar e evita c√£ibras na perna.", img: "img/amarelo/banana_amarela.jpg", emoji: "üçå"},
                    {text: "a casca da banana tamb√©m tem vitaminas e pode ser usada em bolos.", img: "img/amarelo/banana_amarela.jpg", emoji: "üçå"},
                    {text: "o pintinho j√° conversa piando dentro do ovo antes de nascer.", img: "img/amarelo/pintinho_amarelo.jpg", emoji: "üê•"},
                    {text: "pintinhos nascem com olhos abertos e j√° sabem andar e comer.", img: "img/amarelo/pintinho_amarelo.jpg", emoji: "üê•"},
                    {text: "o lim√£o siciliano √© amarelinho e tem sabor mais suave que o lim√£o verde.", img: "img/amarelo/limao_amarelo.jpg", emoji: "üçã"},
                    {text: "a vitamina do lim√£o ajuda a gente a n√£o pegar gripe.", img: "img/amarelo/limao_amarelo.jpg", emoji: "üçã"}
                ] 
            },
            "Verde": { 
                hueMin: 71, hueMax: 165, satMin: 25, ligMin: 15, ligMax: 90, color: "#00E676", 
                facts: [
                    {text: "as √°rvores conversam umas com as outras pelas ra√≠zes debaixo da terra.", img: "img/verde/arvore_verde.jpg", emoji: "üå≥"},
                    {text: "uma √°rvore grande pode beber muita √°gua e evitar enchentes.", img: "img/verde/arvore_verde.jpg", emoji: "üå≥"},
                    {text: "as √°rvores limpam o ar e deixam a cidade mais fresca.", img: "img/verde/arvore_verde.jpg", emoji: "üå≥"},
                    {text: "na natureza, cores brilhantes como a do sapo verde avisam: 'n√£o me toque!'", img: "img/verde/sapo_verde.jpg", emoji: "üê∏"},
                    {text: "esse sapinho vive na floresta Amaz√¥nica e adora lugares √∫midos.", img: "img/verde/sapo_verde.jpg", emoji: "üê∏"},
                    {text: "o br√≥colis tem tanto c√°lcio que ajuda a deixar seus ossos fortes.", img: "img/verde/brocolis_verde.jpg", emoji: "ü•¶"},
                    {text: "o nome br√≥colis vem do italiano e significa 'brotos pontudos'.", img: "img/verde/brocolis_verde.jpg", emoji: "ü•¶"},
                    {text: "a tartaruga verde pode viver mais de 80 anos viajando pelo mar.", img: "img/verde/tartaruga_verde.jpg", emoji: "üê¢"},
                    {text: "elas conseguem prender a respira√ß√£o por muitos minutos embaixo d'√°gua.", img: "img/verde/tartaruga_verde.jpg", emoji: "üê¢"},
                    {text: "o abacate tem uma gordura boa que faz bem para o cora√ß√£o.", img: "img/verde/abacate_verde.jpg", emoji: "ü•ë"},
                    {text: "os povos antigos chamavam o abacate de 'ouro verde' por ser valioso.", img: "img/verde/abacate_verde.jpg", emoji: "ü•ë"}
                ] 
            },
            "Azul": { 
                hueMin: 176, hueMax: 260, satMin: 30, ligMin: 15, ligMax: 85, color: "#2979FF", 
                facts: [
                    {text: "o mar cobre quase todo o nosso planeta e produz o ar que respiramos.", img: "img/azul/oceano_azul.jpg", emoji: "üåä"},
                    {text: "existem milhares de bichinhos no mar que a gente ainda nem descobriu.", img: "img/azul/oceano_azul.jpg", emoji: "üåä"},
                    {text: "o c√©u √© azul porque a luz do sol se espalha no ar.", img: "img/azul/ceu_azul.jpg", emoji: "‚òÅÔ∏è"},
                    {text: "nossos olhos s√£o sens√≠veis √† cor azul, por isso vemos o c√©u assim.", img: "img/azul/ceu_azul.jpg", emoji: "‚òÅÔ∏è"},
                    {text: "o bico da arara azul √© t√£o forte que quebra sementes duras.", img: "img/azul/arara_azul.jpg", emoji: "ü¶ú"},
                    {text: "araras azuis gostam de conversar e fazem bastante barulho na floresta.", img: "img/azul/arara_azul.jpg", emoji: "ü¶ú"},
                    {text: "o mirtilo √© uma frutinha super poderosa que ajuda na mem√≥ria.", img: "img/azul/mirtilo_azul.jpg", emoji: "ü´ê"},
                    {text: "essa cor azul escura vem de uma 'tinta' natural muito saud√°vel.", img: "img/azul/mirtilo_azul.jpg", emoji: "ü´ê"},
                    {text: "a baleia azul √© o maior animal que j√° existiu, maior que os dinossauros!", img: "img/azul/baleia_azul.jpg", emoji: "üêã"},
                    {text: "a l√≠ngua de uma baleia azul pesa o mesmo que um elefante.", img: "img/azul/baleia_azul.jpg", emoji: "üêã"}
                ] 
            },
            "Roxo": { 
                hueMin: 256, hueMax: 295, satMin: 20, ligMin: 15, ligMax: 80, color: "#AA00FF", 
                facts: [
                    {text: "uvas roxas fazem bem para o cora√ß√£o e d√£o energia.", img: "img/roxo/uva_roxa.jpg", emoji: "üçá"},
                    {text: "se a uva roxa secar no sol, ela vira uma uva-passa!", img: "img/roxo/uva_roxa.jpg", emoji: "üçá"},
                    {text: "o cheirinho da lavanda ajuda a gente a ficar calmo e dormir bem.", img: "img/roxo/lavanda_roxa.jpg", emoji: "üå∏"},
                    {text: "lavandas gostam de muito sol para crescerem bonitas e cheirosas.", img: "img/roxo/lavanda_roxa.jpg", emoji: "üå∏"},
                    {text: "a beringela √© parente do tomate e da batata.", img: "img/roxo/beringela_roxa.jpg", emoji: "üçÜ"},
                    {text: "comemos o fruto da beringela, mas as folhas a gente deixa pra l√°!", img: "img/roxo/beringela_roxa.jpg", emoji: "üçÜ"},
                    {text: "o polvo tem 3 cora√ß√µes e √© muito inteligente.", img: "img/roxo/polvo_roxo.jpg", emoji: "üêô"},
                    {text: "esse polvo mostra an√©is azuis brilhantes para avisar que √© perigoso.", img: "img/roxo/polvo_roxo.jpg", emoji: "üêô"},
                    {text: "o polvo consegue mudar de cor para se esconder na areia.", img: "img/roxo/polvo_roxo.jpg", emoji: "üêô"},
                    {text: "ametista √© uma pedra preciosa que reis e rainhas adoravam usar.", img: "img/roxo/ametista_roxa.jpg", emoji: "üíé"},
                    {text: "a ametista fica com essa cor roxa por causa do calor no fundo da terra.", img: "img/roxo/ametista_roxa.jpg", emoji: "üíé"}
                ] 
            },
            "Rosa": { 
                hueMin: 296, hueMax: 339, satMin: 30, ligMin: 40, ligMax: 90, color: "#FF4081", 
                facts: [
                    {text: "o flamingo nasce branco! Ele fica rosa porque come camar√£ozinho.", img: "img/rosa/flamingo_rosa.jpg", emoji: "ü¶©"},
                    {text: "o flamingo consegue dormir em p√© numa perna s√≥.", img: "img/rosa/flamingo_rosa.jpg", emoji: "ü¶©"},
                    {text: "o boto rosa vive nos rios da Amaz√¥nia e √© muito brincalh√£o.", img: "img/rosa/boto_rosa.jpg", emoji: "üê¨"},
                    {text: "o boto rosa usa sons debaixo d'√°gua para encontrar peixinhos para comer.", img: "img/rosa/boto_rosa.jpg", emoji: "üê¨"},
                    {text: "os porquinhos rolam na lama para se proteger do calor, igual protetor solar.", img: "img/rosa/porco_rosa.jpg", emoji: "üê∑"},
                    {text: "o porco √© muito esperto e tem um olfato incr√≠vel.", img: "img/rosa/porco_rosa.jpg", emoji: "üê∑"},
                    {text: "flores cor-de-rosa atraem muitas borboletas para o jardim.", img: "img/rosa/flor_rosa.jpg", emoji: "üå∏"},
                    {text: "o hibisco rosa abre de manh√£ e fecha de noite.", img: "img/rosa/flor_rosa.jpg", emoji: "üå∏"},
                    {text: "o sorvete quanto mais batido for, mais cremoso ele fica.", img: "img/rosa/sorvete_rosa.jpg", emoji: "üç¶"},
                    {text: "antigamente, o sorvete era uma mistura de neve com frutas e mel.", img: "img/rosa/sorvete_rosa.jpg", emoji: "üç¶"}
                ] 
            }
        };

        const challenges = Object.keys(targets);

        if ('speechSynthesis' in window) {
            loadVoices();
            window.speechSynthesis.onvoiceschanged = function() { loadVoices(); };
        }

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            voice = voices.find(v => v.name.includes('Google Portugu√™s') || v.name.includes('Microsoft Maria'));
            if (!voice) voice = voices.find(v => v.lang.includes('pt-BR'));
        }

        function startGame() {
            childName = nameInput.value.trim();
            if (!childName) {
                alert("Por favor, digite seu nome!");
                return;
            }
            loadVoices();
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    video.srcObject = stream; video.play();
                    startScreen.style.display = "none";
                    scannerFrame.style.display = "block";
                    bottomArea.style.display = "flex";
                    exitBtn.style.display = "flex";
                    skipBtn.style.display = "none"; 
                    gameStarted = true;
                    requestAnimationFrame(loop);
                    speak("Ol√°, " + childName + "! \nEu sou a √çris. Vamos ca√ßar cores?", () => { nextChallenge(); });
                })
                .catch(err => { alert("Erro: C√¢mera n√£o encontrada."); });
        }

        function endGame() {
            gameStarted = false; lockGame = true;
            clearTimeout(idleTimer15); clearTimeout(idleTimer60);
            speak("At√© logo, " + childName, () => { location.reload(); });
        }

        function resetIdle() {
            clearTimeout(idleTimer15); clearTimeout(idleTimer60);
            idleTimer15 = setTimeout(() => {
                if(!lockGame && gameStarted) {
                    speak(childName + ", voc√™ ainda est√° a√≠? \nSe n√£o encontrar algo " + currentTarget + ", vamos para a pr√≥xima.");
                }
            }, 15000); 
            idleTimer60 = setTimeout(() => {
                if(!lockGame && gameStarted) {
                    speak(childName + ", aguardo voc√™ para iniciarmos uma nova jornada.", () => { location.reload(); });
                }
            }, 60000);
        }

        function getRandomFact(colorKey) {
            const facts = targets[colorKey].facts;
            let newIndex = Math.floor(Math.random() * facts.length);
            if (facts.length > 1 && newIndex === currentFactIndex) {
                newIndex = (newIndex + 1) % facts.length;
            }
            currentFactIndex = newIndex;
            return facts[newIndex];
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function nextChallenge() {
            if(lockGame || !gameStarted) return;
            resetIdle(); 
            if (challengeBag.length === 0) {
                challengeBag = [...challenges];
                shuffleArray(challengeBag);
                if (challengeBag[0] === currentTarget && challengeBag.length > 1) {
                    let temp = challengeBag[0];
                    challengeBag[0] = challengeBag[challengeBag.length - 1];
                    challengeBag[challengeBag.length - 1] = temp;
                }
            }
            currentTarget = challengeBag.pop();
            const t = targets[currentTarget];
            targetText.innerText = currentTarget;
            targetText.style.color = t.color;
            targetDot.style.backgroundColor = t.color;
            targetBar.style.transform = "scale(1)"; 
            
            curiosityCard.classList.remove('active');
            skipBtn.style.display = "flex"; 
            scannerFrame.style.borderColor = "#FFF";
            holdCounter = 0; wrongColorCounter = 0;
            speak("Encontre algo " + currentTarget + "!"); 
        }

        function skipChallenge() {
            if(!gameStarted || lockGame || !currentTarget) return;
            lockGame = true;
            clearTimeout(idleTimer15);
            skipBtn.style.opacity = "0.5";
            const t = targets[currentTarget];
            const factObj = getRandomFact(currentTarget);
            const phrase = "Tudo bem, " + childName + ", voc√™ sabia que " + factObj.text;
            showVisualContent(factObj, "MISS√ÉO PULADA", t.color);
            speak(phrase, function() {
                setTimeout(() => { lockGame = false; skipBtn.style.opacity = "1"; nextChallenge(); }, 1500); 
            });
        }

        function victory() {
            lockGame = true;
            clearTimeout(idleTimer15);
            const t = targets[currentTarget];
            const factObj = getRandomFact(currentTarget);
            scannerFrame.style.borderColor = t.color;
            const phrase = "Voc√™ sabia que " + factObj.text;
            showVisualContent(factObj, "ALVO LOCALIZADO!", t.color);
            speak(phrase, function() {
                setTimeout(() => { lockGame = false; nextChallenge(); }, 1000); 
            });
        }

        function showVisualContent(factObj, title, color) {
            victoryTitle.innerText = title;
            victoryTitle.style.color = color;
            curiosityCard.classList.add('active');
            curiosityImage.style.display = "block";
            backupEmoji.style.display = "none";
            curiosityImage.src = factObj.img;
            curiosityImage.onerror = function() {
                this.style.display = "none";
                backupEmoji.innerText = factObj.emoji;
                backupEmoji.style.display = "block";
            };
        }

        function loop() {
            if (!video.videoWidth) { requestAnimationFrame(loop); return; }
            if (canvas.width !== video.videoWidth) { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            if (!gameStarted) { requestAnimationFrame(loop); return; }
            const cx = Math.floor(canvas.width / 2);
            const cy = Math.floor(canvas.height / 2);
            const pData = ctx.getImageData(cx - 15, cy - 15, 30, 30).data;
            let r=0, g=0, b=0, c=0;
            for (let i = 0; i < pData.length; i += 4) { r += pData[i]; g += pData[i+1]; b += pData[i+2]; c++; }
            r = Math.floor(r/c); g = Math.floor(g/c); b = Math.floor(b/c);
            const hsl = rgbToHsl(r, g, b);
            analyzeColor(hsl[0], hsl[1], hsl[2]);
            requestAnimationFrame(loop);
        }

        function analyzeColor(h, s, l) {
            if (lockGame || !gameStarted || !currentTarget) return;
            let detectedName = null;
            for (let name of challenges) {
                const t = targets[name];
                let minSat = t.satMin;
                if (l > 85) minSat = 40; 
                let match = false;
                if (name === "Vermelho") { 
                    if (h >= t.hueMin || h <= t.hueMax) match = true; 
                } else { 
                    if (h >= t.hueMin && h <= t.hueMax) match = true; 
                }
                if (match && s >= minSat && l >= t.ligMin && l <= t.ligMax) {
                    detectedName = name; break; 
                }
            }
            if (detectedName === currentTarget) {
                wrongColorCounter = 0; holdCounter++;
                if(holdCounter > 5) scannerFrame.style.borderColor = targets[currentTarget].color; 
                if (holdCounter > 30) victory(); 
            } else {
                holdCounter = 0; scannerFrame.style.borderColor = "#FFF";
                if (detectedName && detectedName !== currentTarget) {
                    if (detectedName === lastWrongColorName) wrongColorCounter++;
                    else { wrongColorCounter = 0; lastWrongColorName = detectedName; }
                    if (wrongColorCounter > 60 && !errorCooldown && !window.speechSynthesis.speaking) {
                        resetIdle(); triggerErrorFeedback(detectedName);
                    }
                }
            }
        }

        function triggerErrorFeedback(wrongColor) {
            errorCooldown = true; 
            speak("Isso parece " + wrongColor + ". Procure algo " + currentTarget + ".", function() {
                setTimeout(() => { errorCooldown = false; }, 2000);
            });
        }

        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max == min) { h = s = 0; } 
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                } h /= 6;
            } return [h * 360, s * 100, l * 100];
        }

	function speak(text, callback) {
            bubbleText.innerText = text; bubbleText.style.opacity = "1"; 
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                let cleanText = text.replace(/\n/g, " ");
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'pt-BR'; u.rate = 1.0; u.pitch = 1.2; 
                if (voice) u.voice = voice;
                u.onend = function() { if(callback) callback(); };
                u.onerror = function() { if(callback) callback(); };
                window.speechSynthesis.speak(u);
            } else { if(callback) setTimeout(callback, 2000); }
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('App pronto!', reg.scope))
                    .catch(err => console.log('Falha ao registrar App:', err));
            });
        }
    </script>
</body>
</html>